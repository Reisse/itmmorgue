#!/bin/sh
# vim: sw=4 ts=4 et :

OS=`uname -s`
EXECUTABLE='itmmorgue'
SRC='itmmorgue.c client.c config.c splash.c i18n.c'
HDR='itmmorgue.h client.h config.h'
SRCDIR='src'
WORKDIR='bin'

CC='gcc'
CFLAGS='--std=gnu99 -pedantic -Wall -Wextra -Werror -ggdb3'
LDFLAGS=''
MAKE='make'

case $OS in
    SunOS) 
        LDFLAGS="$LDFLAGS -L /opt/csw/lib/"
        CFLAGS="$CFLAGS -L /opt/csw/lib/ -I /opt/sfw/include/ -lncursesw"
        MAKE=gmake
        VARS_CLIENT='TERM=screen'
        ;;
    FreeBSD)
        CC=cc
        MAKE=gmake
        LDFLAGS="$LDFLAGS -L /usr/local/lib/ -lncursesw -ltinfow"
        ;;
    Linux)
        CFLAGS="$CFLAGS -lncursesw"
        ;;
    *) echo Unsupported platform! >&2 ; exit 2
        ;;
esac

cat > Makefile <<EOF
# Makefile for $OS
EXECUTABLE=$EXECUTABLE
SRC=$SRC
SOURCES=\$(addprefix $SRCDIR/, \$(SRC))
HDR=$HDR
HEADERS=\$(addprefix $SRCDIR/, \$(HDR))
OBJ=\$(SRC:.c=.o)
WORKDIR=$WORKDIR
OBJECTS=\$(addprefix \$(WORKDIR)/, \$(OBJ))

CC=$CC
CFLAGS=$CFLAGS
LDFLAGS=$LDFLAGS

all: \$(WORKDIR)/\$(EXECUTABLE)

\$(WORKDIR):
	mkdir \$(WORKDIR)

\$(WORKDIR)/\$(EXECUTABLE): \$(OBJECTS)
	\$(CC) \$(LDFLAGS) \$(CFLAGS) \$(OBJECTS) -o \$@

\$(WORKDIR)/%.o : src/%.c
	\$(CC) \$(CFLAGS) -c \$< -o \$@

\$(SOURCES): \$(WORKDIR)

run: run_client

run_client: \$(WORKDIR)/\$(EXECUTABLE)
	$VARS_CLIENT \$(WORKDIR)/\$(EXECUTABLE)

clean:
	\$(RM) -rf \$(WORKDIR)

.SUFFIXES: .c .o
EOF

echo "Successfully configured for $OS. Please run $MAKE now." >&2
